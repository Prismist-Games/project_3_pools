[gd_scene load_steps=32 format=3 uid="uid://05ku7kwq0dxp"]

[ext_resource type="Script" uid="uid://con7nyakgbhan" path="res://scripts/ui/components/quest_slot_ui.gd" id="1_cf02l"]
[ext_resource type="Texture2D" uid="uid://bk6w30hxghp51" path="res://assets/sprites/quest_slots/基地-7.png" id="2_5cnt1"]
[ext_resource type="Script" uid="uid://rg8ahiwfwlxb" path="res://scripts/ui/utils/slot_background_color_setter.gd" id="3_xy8au"]
[ext_resource type="Texture2D" uid="uid://b6sygmv0sgt3g" path="res://assets/sprites/quest_slots/基地-3.png" id="4_8oyay"]
[ext_resource type="Texture2D" uid="uid://cppyh38s818ov" path="res://assets/sprites/quest_slots/基地-2.png" id="5_cm3rb"]
[ext_resource type="Texture2D" uid="uid://fb6h3kogm80w" path="res://assets/sprites/quest_slots/基地-4.png" id="6_cpuw7"]
[ext_resource type="Texture2D" uid="uid://w7eym4f1436o" path="res://assets/sprites/quest_slots/基地-1.png" id="7_2pth6"]
[ext_resource type="Texture2D" uid="uid://ddmgresex11px" path="res://assets/sprites/icons/money.png" id="8_uawe1"]
[ext_resource type="FontFile" uid="uid://bpg3iakb3o07a" path="res://assets/fonts/51282.otf" id="9_x1b4l"]
[ext_resource type="Texture2D" uid="uid://nju4di4bai4r" path="res://assets/sprites/icons/items/item_shape_centered.png" id="10_8oyay"]
[ext_resource type="Shader" uid="uid://cjs8tedhdkq2m" path="res://assets/shaders/desaturate.gdshader" id="10_cm3rb"]
[ext_resource type="Texture2D" uid="uid://davbf6tu8eie1" path="res://assets/sprites/quest_slots/quality_label.PNG" id="11_8oyay"]
[ext_resource type="Texture2D" uid="uid://h5k15o8ewu4i" path="res://assets/sprites/icons/item_rarity_glow.PNG" id="12_xy8au"]
[ext_resource type="Texture2D" uid="uid://jirxtbdwgrjx" path="res://assets/sprites/icons/tick_green.png" id="13_n0e4s"]
[ext_resource type="Texture2D" uid="uid://ccgio8dnutusa" path="res://assets/sprites/quest_slots/quest_slot_door.PNG" id="14_5cnt1"]
[ext_resource type="Texture2D" uid="uid://b83tw66bk1v5s" path="res://assets/sprites/quest_slots/基地-6.png" id="15_vvcjj"]
[ext_resource type="Texture2D" uid="uid://beldg0xqocq2k" path="res://assets/sprites/quest_slots/基地-5.png" id="16_6ixpp"]
[ext_resource type="Texture2D" uid="uid://catqi262iinqu" path="res://assets/sprites/quest_slots/正常按钮.png" id="17_cf02l"]
[ext_resource type="Texture2D" uid="uid://dhiw5ekpxpxp" path="res://assets/sprites/quest_slots/按下去按钮.png" id="18_5cnt1"]
[ext_resource type="Texture2D" uid="uid://ckul04ymxsleg" path="res://assets/sprites/quest_slots/废废按钮.png" id="20_cf02l"]
[ext_resource type="Texture2D" uid="uid://ductaol4jp4ix" path="res://assets/sprites/quest_slots/ho按钮.png" id="20_xy8au"]
[ext_resource type="Texture2D" uid="uid://cndfk2veulvf7" path="res://assets/sprites/quest_slots/1.png" id="22_xy8au"]
[ext_resource type="Texture2D" uid="uid://bq06dygb38pu3" path="res://assets/sprites/quest_slots/2.png" id="23_8oyay"]

[sub_resource type="ShaderMaterial" id="ShaderMaterial_xy8au"]
shader = ExtResource("10_cm3rb")
shader_parameter/line_color = Color(1, 1, 1, 1)
shader_parameter/width = 11.0490005248275
shader_parameter/pattern = 0
shader_parameter/inside = false
shader_parameter/add_margins = false
shader_parameter/number_of_images = Vector2(1, 1)
shader_parameter/saturation = 1.0
shader_parameter/preview_stroke_mode = false
shader_parameter/stroke_color = Color(0.36408392, 0.36408395, 0.36408386, 1)
shader_parameter/fill_color = Color(0.8546343, 0.85463387, 0.85463387, 1)
shader_parameter/stroke_threshold = 0.2990000142025

[sub_resource type="AtlasTexture" id="AtlasTexture_cm3rb"]
atlas = ExtResource("10_8oyay")
region = Rect2(1500, 1500, 500, 500)

[sub_resource type="Shader" id="Shader_rqxoj"]
code = "shader_type canvas_item;

uniform float scanline_count : hint_range(0, 1800) = 50.0;
uniform float scanline_alpha : hint_range(0, 1) = 0.5;
uniform float scanline_speed : hint_range(-10.0, 10.0) = 1.0;  // New: Speed of scanline movement

uniform float vignette_intensity : hint_range(0, 5) = 0.4;
uniform float screen_curvature : hint_range(0, 0.1) = 0.05;

uniform float jitter_intensity : hint_range(0, 0.1) = 0.0; // New: Jitter amount
uniform float noise_intensity : hint_range(0, 1) = 0.0;     // New: Static noise amount

// Helper function for pseudo-random numbers
float random(vec2 uv) {
    return fract(sin(dot(uv.xy, vec2(12.9898,78.233))) * 43758.5453123);
}

void fragment() {
	vec2 uv = UV;
	
	// 1. Screen Curvature / Warp
	// Distort UVs from center
	vec2 center = vec2(0.5, 0.5);
	vec2 offset = uv - center;
	float dist_sq = dot(offset, offset);
	// Basic barrel distortion
	vec2 warped_uv = uv + offset * (dist_sq * screen_curvature);
	
	// If warped UV is outside [0,1], discard or mask (optional, but for overlay we might just want to let it vignette)
	
	// 2. Jitter
	// Offset warped_uv slightly based on time
	float time_step = floor(TIME * 60.0); // Jitter at 60fps intervals
	vec2 jitter_offset = vec2(
		random(vec2(time_step, 1.0)) - 0.5,
		random(vec2(time_step, 2.0)) - 0.5
	) * jitter_intensity;
	
	// Apply jitter to the texture look-up UVs (if we were warping the underlying texture)
	// But since we are an OVERLAY, we aren't distorting the underlying texture directly unless we use SCREEN_TEXTURE.
	// However, this shader is applied to a ColorRect on TOP of content.
	// Standard approach for overlay is to just draw effects over the top.
	// IF we want to distort the underlying text, we would need to use a BackBufferCopy or Screen reading shader.
	// Given the instructions (\"add visual effects... to these screens\"), and previous setup involving ColorRect overlay:
	// Let's stick to generating effects *on top* that simulate imperfections, 
	// rather than warping the actual game text (which is safer for readability).
	// BUT, \"Curvature\" usually implies geometric distortion.
	// Since we are just a ColorRect overlay, we can use the curvature to curve the SCANLINES and VIGNETTE.
	
	// Use warped_uv for generating scanlines/vignette to match the curved look
	
	// 3. Scanlines with Roll
	// Use warped_uv.y + TIME for movement
	float scanline = sin((warped_uv.y + TIME * scanline_speed * 0.01) * scanline_count * 3.14159 * 2.0);
	scanline = (scanline + 1.0) * 0.5;
	
	// 4. White Noise
	float noise_val = random(warped_uv + vec2(TIME, TIME));
	
	// 5. Vignette (using warped coords)
	float vig_dist = length(warped_uv - center);
	float vig = smoothstep(0.4, 0.4 + 0.3, vig_dist) * vignette_intensity;

	// Compose Color
	// Start with black
	vec3 dark_color = vec3(0.0);
	
	// Scanlines darken the screen
	float sl_alpha = scanline * scanline_alpha;
	
	// Jitter effect on overlay: random flashes or horizontal offsets?
	// Let's do a horizontal \"tearing\" scanline occasionall?
	// Or just keep it simple: Jitter shifts the scanlines slightly.
	
	// Update alpha
	float final_alpha = sl_alpha + vig;
	
	// Add noise (whitening)
	vec3 noise_color = vec3(noise_val);
	// Noise adds to color, doesn't just alpha blend black
	
	// Output
	// We mix black overlay (scanlines/vignette) with white noise.
	// This is an overlay, so COLOR.a determines how much we darken/lighten.
	// Darkening: (0,0,0, alpha)
	// Lightening: (1,1,1, alpha)
	// We want mostly darkening, but noise adds light.
	
	COLOR.rgb = noise_color * noise_intensity;
	COLOR.a = clamp(final_alpha + (noise_val * noise_intensity * 0.1), 0.0, 1.0);
}
"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_8oyay"]
shader = SubResource("Shader_rqxoj")
shader_parameter/scanline_count = 20.00000095
shader_parameter/scanline_alpha = 0.15
shader_parameter/scanline_speed = 10.0
shader_parameter/vignette_intensity = 0.4
shader_parameter/screen_curvature = 0.05
shader_parameter/jitter_intensity = 0.002
shader_parameter/noise_intensity = 0.05

[sub_resource type="Animation" id="Animation_8ocj1"]
length = 0.001
tracks/0/type = "bezier"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Quest Slot_mask/Quest Slot_lid:position:y")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"handle_modes": PackedInt32Array(0),
"points": PackedFloat32Array(0, -0.25, 0, 0.25, 0),
"times": PackedFloat32Array(0)
}

[sub_resource type="Animation" id="Animation_jdak2"]
resource_name = "lid_close"
length = 0.7
tracks/0/type = "bezier"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Quest Slot_mask/Quest Slot_lid:position:y")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"handle_modes": PackedInt32Array(0, 0),
"points": PackedFloat32Array(-220, -0.25, 0, 0.3, 0.72340393, 3.8154068, -0.5333333, -2.1447449, 0, 0),
"times": PackedFloat32Array(0, 0.7)
}

[sub_resource type="Animation" id="Animation_jufyi"]
resource_name = "lid_open"
length = 0.7
tracks/0/type = "bezier"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Quest Slot_mask/Quest Slot_lid:position:y")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"handle_modes": PackedInt32Array(0, 0),
"points": PackedFloat32Array(0, -0.25, 0, 0.3, -11.704876, -221.2287, -0.5333333, 23.280426, 0, 0),
"times": PackedFloat32Array(0, 0.7)
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_jdak2"]
_data = {
&"RESET": SubResource("Animation_8ocj1"),
&"lid_close": SubResource("Animation_jdak2"),
&"lid_open": SubResource("Animation_jufyi")
}

[node name="Quest Slot_root_1" type="Control"]
layout_mode = 3
anchors_preset = 0
script = ExtResource("1_cf02l")

[node name="Quest Slot_mask" type="Sprite2D" parent="."]
clip_children = 1
texture = ExtResource("2_5cnt1")

[node name="Quest Slot_background" type="Node2D" parent="Quest Slot_mask"]
script = ExtResource("3_xy8au")
color = Color(1, 0.79607844, 0.03137255, 1)

[node name="Slot_background_side" type="Sprite2D" parent="Quest Slot_mask/Quest Slot_background"]
modulate = Color(1, 0.79607844, 0.03137255, 1)
texture = ExtResource("4_8oyay")

[node name="Slot_background_wall" type="Sprite2D" parent="Quest Slot_mask/Quest Slot_background"]
modulate = Color(1, 0.79607844, 0.03137255, 1)
texture = ExtResource("5_cm3rb")

[node name="Slot_background_floor" type="Sprite2D" parent="Quest Slot_mask/Quest Slot_background"]
modulate = Color(1, 0.79607844, 0.03137255, 1)
texture = ExtResource("6_cpuw7")

[node name="Slot_background_outline" type="Sprite2D" parent="Quest Slot_mask/Quest Slot_background"]
texture = ExtResource("7_2pth6")

[node name="Quest Reward Icon" type="TextureRect" parent="Quest Slot_mask"]
offset_left = -394.0
offset_top = -59.25
offset_right = -308.0
offset_bottom = 6.75
texture = ExtResource("8_uawe1")
expand_mode = 5

[node name="Quest Reward Label" type="RichTextLabel" parent="Quest Slot_mask/Quest Reward Icon"]
layout_mode = 1
anchors_preset = 4
anchor_top = 0.5
anchor_bottom = 0.5
offset_left = 90.0
offset_top = -97.0
offset_right = 979.0
offset_bottom = 96.0
grow_vertical = 2
theme_override_colors/default_color = Color(0, 0, 0, 1)
theme_override_fonts/normal_font = ExtResource("9_x1b4l")
theme_override_font_sizes/normal_font_size = 141
bbcode_enabled = true
text = "33 [s]25[/s]"
fit_content = true
scroll_active = false
vertical_alignment = 1

[node name="Quest Slot Items Grid" type="HBoxContainer" parent="Quest Slot_mask"]
offset_left = -147.0
offset_top = 23.75
offset_right = 1053.0
offset_bottom = 63.75
scale = Vector2(0.5, 0.5)
theme_override_constants/separation = 325
alignment = 2

[node name="Quest Slot Item_root_0" type="Control" parent="Quest Slot_mask/Quest Slot Items Grid"]
layout_mode = 2

[node name="Item_icon" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_0"]
material = SubResource("ShaderMaterial_xy8au")
position = Vector2(0, -17.5)
scale = Vector2(0.9, 0.9)
texture = SubResource("AtlasTexture_cm3rb")

[node name="Item_rarity" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_0/Item_icon"]
modulate = Color(0.18431373, 0.74509805, 0.2, 1)
show_behind_parent = true
texture = ExtResource("12_xy8au")

[node name="Item_status" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_0"]
position = Vector2(104.399994, -134.5)
scale = Vector2(1.3499999, 1.3499999)
texture = ExtResource("13_n0e4s")

[node name="Item_requirement" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_0"]
modulate = Color(0.99215686, 0.5921569, 0.18431373, 1)
position = Vector2(0, 172.5)
scale = Vector2(1.8, 1.8)
texture = ExtResource("11_8oyay")

[node name="Quest Slot Item_root_1" type="Control" parent="Quest Slot_mask/Quest Slot Items Grid"]
layout_mode = 2

[node name="Item_icon" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_1"]
material = SubResource("ShaderMaterial_xy8au")
position = Vector2(0, -17.5)
scale = Vector2(0.9, 0.9)
texture = SubResource("AtlasTexture_cm3rb")

[node name="Item_rarity" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_1/Item_icon"]
modulate = Color(0.18431373, 0.74509805, 0.2, 1)
show_behind_parent = true
texture = ExtResource("12_xy8au")

[node name="Item_status" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_1"]
position = Vector2(104.399994, -134.5)
scale = Vector2(1.3499999, 1.3499999)
texture = ExtResource("13_n0e4s")

[node name="Item_requirement" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_1"]
modulate = Color(0.99215686, 0.5921569, 0.18431373, 1)
position = Vector2(0, 172.5)
scale = Vector2(1.8, 1.8)
texture = ExtResource("11_8oyay")

[node name="Quest Slot Item_root_2" type="Control" parent="Quest Slot_mask/Quest Slot Items Grid"]
layout_mode = 2

[node name="Item_icon" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_2"]
material = SubResource("ShaderMaterial_xy8au")
position = Vector2(0, -17.5)
scale = Vector2(0.9, 0.9)
texture = SubResource("AtlasTexture_cm3rb")

[node name="Item_rarity" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_2/Item_icon"]
modulate = Color(0.18431373, 0.74509805, 0.2, 1)
show_behind_parent = true
texture = ExtResource("12_xy8au")

[node name="Item_status" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_2"]
position = Vector2(104.399994, -134.5)
scale = Vector2(1.3499999, 1.3499999)
texture = ExtResource("13_n0e4s")

[node name="Item_requirement" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_2"]
modulate = Color(0.99215686, 0.5921569, 0.18431373, 1)
position = Vector2(0, 172.5)
scale = Vector2(1.8, 1.8)
texture = ExtResource("11_8oyay")

[node name="Quest Slot Item_root_3" type="Control" parent="Quest Slot_mask/Quest Slot Items Grid"]
layout_mode = 2

[node name="Item_icon" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_3"]
material = SubResource("ShaderMaterial_xy8au")
position = Vector2(0, -17.5)
scale = Vector2(0.9, 0.9)
texture = SubResource("AtlasTexture_cm3rb")

[node name="Item_rarity" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_3/Item_icon"]
modulate = Color(0.18431373, 0.74509805, 0.2, 1)
show_behind_parent = true
texture = ExtResource("12_xy8au")

[node name="Item_status" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_3"]
position = Vector2(104.399994, -134.5)
scale = Vector2(1.3499999, 1.3499999)
texture = ExtResource("13_n0e4s")

[node name="Item_requirement" type="Sprite2D" parent="Quest Slot_mask/Quest Slot Items Grid/Quest Slot Item_root_3"]
modulate = Color(0.99215686, 0.5921569, 0.18431373, 1)
position = Vector2(0, 172.5)
scale = Vector2(1.8, 1.8)
texture = ExtResource("11_8oyay")

[node name="Quest Slot_lid" type="Sprite2D" parent="Quest Slot_mask"]
texture = ExtResource("14_5cnt1")
offset = Vector2(0, -26.175)

[node name="Quest Slot_outline" type="Sprite2D" parent="."]
self_modulate = Color(0.99607843, 0.90588236, 0.2901961, 1)
texture = ExtResource("15_vvcjj")

[node name="Quest Slot_outline" type="Sprite2D" parent="Quest Slot_outline"]
texture = ExtResource("16_6ixpp")

[node name="Input Area" type="Control" parent="."]
anchors_preset = 0
offset_left = -461.0
offset_top = -127.0
offset_right = 711.0
offset_bottom = 162.0
mouse_default_cursor_shape = 2

[node name="Refresh Button" type="TextureButton" parent="."]
layout_mode = 0
offset_left = 595.0
offset_top = -111.0
offset_right = 722.0
offset_bottom = 30.0
mouse_default_cursor_shape = 2
texture_normal = ExtResource("17_cf02l")
texture_pressed = ExtResource("18_5cnt1")
texture_hover = ExtResource("20_xy8au")
texture_disabled = ExtResource("20_cf02l")

[node name="Refresh Screen_outline" type="Sprite2D" parent="Refresh Button"]
position = Vector2(53.5, 180.5)
texture = ExtResource("23_8oyay")

[node name="Refresh Screen_fill" type="Sprite2D" parent="Refresh Button/Refresh Screen_outline"]
self_modulate = Color(0.88235295, 0.39215687, 0.3882353, 1)
show_behind_parent = true
clip_children = 2
texture = ExtResource("22_xy8au")

[node name="Refresh Count Label" type="RichTextLabel" parent="Refresh Button/Refresh Screen_outline/Refresh Screen_fill"]
offset_left = -41.5
offset_top = -53.5
offset_right = 32.5
offset_bottom = 42.5
mouse_filter = 2
theme_override_colors/default_color = Color(1, 1, 1, 1)
theme_override_font_sizes/normal_font_size = 84
bbcode_enabled = true
text = "2"
scroll_active = false
horizontal_alignment = 1
vertical_alignment = 1

[node name="ScreenEffectOverlay" type="ColorRect" parent="Refresh Button/Refresh Screen_outline/Refresh Screen_fill"]
material = SubResource("ShaderMaterial_8oyay")
offset_left = -54.5
offset_top = -66.5
offset_right = 39.5
offset_bottom = 53.5
mouse_filter = 2

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
libraries = {
&"": SubResource("AnimationLibrary_jdak2")
}
