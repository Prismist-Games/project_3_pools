---
alwaysApply: true
---
这份文档定义了基于 Godot 4.5.1 (GDScript) 的游戏项目简介、结构、命名规范和架构模式。请在生成代码时始终参考此文档作为核心上下文。

1. 项目背景与核心机制
    1.1 游戏概述
        这是一款库存管理与订单完成游戏。玩家通过消耗金币或奖券抽取物品，整理背包，合成升级，完成订单以获取更多资源，最终收集 5 个传说级的主线道具通关。
    
    1.2 核心循环
        1. 资源获取: 玩家拥有 金币 (Gold) 和 奖券 (Tickets)。
        2. 抽奖 (Draw):
            界面显示 3 个随机生成的 奖池 (Pools)。
            每个奖池属于特定类型（水果、药物、文具等），并可能带有 词缀 (Affix)。
            玩家点击奖池消耗资源，获得 物品 (Items) 进入 背包 (Inventory)。
        3. 整理与合成:
            合成: 两个相同名称、相同品质且无“绝育”状态的物品可合成为下一级品质。
            回收: 不需要物品可以回收换取少量金币。
        4. 订单 (Orders):
            界面显示 4 个普通订单 + 1 个主线订单（若满足条件）。
            订单要求特定名称和至少特定品质的物品。
            提交订单消耗物品，获得金币或奖券奖励。

    1.3 关键数据定义
        A. 品质 (Rarity)
            - 普通 (common): 40% 概率 | +0% 加成 | 回收值 0 | 颜色特征: 灰色 (Slate)
            - 优秀 (uncommon): 30% 概率 | +10% 加成 | 回收值 0 | 颜色特征: 绿色 (Green)
            - 稀有 (rare): 19% 概率 | +20% 加成 | 回收值 1 | 颜色特征: 蓝色 (Blue)
            - 史诗 (epic): 10% 概率 | +40% 加成 | 回收值 2 | 颜色特征: 紫色 (Purple)
            - 传说 (legendary): 1% 概率 | +100% 加成 | 回收值 4 | 颜色特征: 橙色 (Orange)
            - 神话 (mythic): 0% 概率 | +300% 加成 | 回收值 10 | 颜色特征: 红色 (Rose) 

        B. 奖池词缀 (Affixes): 奖池生成的随机词缀，改变抽奖行为或物品属性
            奖池词缀例子(之后可能会扩展更多):
                - 以旧换新 (Trade-in): 消耗背包 1 个物品，随机置换同品质物品。
                - 硬化的 (Hardened): 稀有度概率提升，但物品 绝育 (Sterile)（不可合成）。
                - 提纯的 (Purified): 保底产出稀有及以上。
                - 波动的 (Volatile): 只有普通或传说，传说概率极高。
                - 稀碎的 (Fragmented): 一次给 3 个物品，但必定是普通。
                - 精准的 (Precise): 二选一 (交互式)。
                - 有的放矢 (Targeted): 指定类型 (交互式)。

        C. 主线流程 (Mainline): 游戏分 5 个阶段，每个阶段需提交特定的神话级主线道具 + 一个随机史诗道具。
            阶段 1: 获得 "仙果" (Fruit) -> 解锁技能槽/新技能
            阶段 2: 获得 "灵丹" (Medicine)
            阶段 3: 获得 "神笔" (Stationery)
            阶段 4: 获得 "金铲铲" (Kitchenware)
            阶段 5: 获得 "特斯拉" (Electronics) -> 通关

        D. 奖池类型与主线池机制
            普通奖池 (Normal Pool):
                消耗: 金币 (Gold)（受词缀影响）。
                内容: 基于种类（水果/药物等）和词缀生成的物品。

            主线奖池 (Mainline Pool):
                出现条件: 玩家持有奖券 10 张以上，且主线未通关。每次刷新有 50% (mainlineChance) 概率替代一个普通池位。
                消耗: 10 张奖券 (Tickets)。
                掉落规则:
                    30% (mainlineDropRate) 概率直接掉落当前阶段的 主线道具 (神话品质 mythic)。
                    70% 概率掉落 填充物 (随机选一个普通池的物品)。
                填充物品质: 必定是 史诗 (Epic, 90%) 或 传说 (Legendary, 10%) (mainlineFillerLegendaryRate)，绝无低级物品。


    1.4 技能系统 (Skill System)
        机制: 被动触发，玩家拥有 3 个技能槽。
        获取: 完成主线任务后，从随机 3 个技能中选 1 个。若槽满需替换。
        技能例子(之后可能会扩展更多):
            【贫困救济】：持有金币 < 5 时，完成订单的金币奖励额外 +10。
            【幸运 7】：当前金币数量的尾数为 7 时，抽取传说物品的概率增加(翻倍)。
            【精打细算】：当前金币 < 10 时，抽奖的金币消耗 -2（最低为1）。
            【炼金术】：回收“稀有”及以上品质物品时，15% 概率获得5张奖券。
            【贵宾折扣】：“精准”和“有的放矢”词缀的奖池金币消耗减少1。
            【谈判专家】：抽到“史诗”或以上品质物品时, 所有订单获得1次刷新次数
            【安慰奖】：连续抽到5个“普通”品质物品后，下次抽奖获得的物品必定是稀有以上品质。
            【偷工减料】：刷新出新订单时，20% 概率使订单需求物品数量 -1（最低为1）。
            【时间冻结】：刷新单个订单时，20% 概率不消耗该订单的剩余刷新次数。
            【强迫症】：提交的订单若所有物品属于同一种类，奖励翻倍。
            【自动补货】：完成任意订单后，下次抽奖获得的物品会多获得1个
            【时来运转】：完成任意订单后，下次抽奖获得的物品必定是稀有以上品质。
            【大订单专家】：完成需求物品数为 4 个的订单时，额外获得10张奖券。
            【困难订单专家】：完成需要史诗以上品质物品的订单时，额外获得15张奖券。


2. 核心架构模式映射 (Architecture Mapping)
    GameCore / Context -> Autoload (Singletons)
    说明：GameManager 管理全局数值，EventBus 管理通信。

    useState -> Variables + Setter/Signal
    说明：变量修改时发出信号 (signal gold_changed(val))。

    useEffect -> Signal Connection
    说明：监听信号并执行回调 (EventBus.connect(...))。

    JSON Data Configs -> Custom Resources (.tres)
    说明：使用继承自 Resource 的类 (ItemData, SkillData, PoolData)。

    Components -> Scenes (.tscn)
    说明：独立的 UI/逻辑模块实例化。

3. 文件目录结构 (File Structure)
    请大致保持以下目录结构, 可以根据之后变化微调：
    res://
    ├── assets/                 # 图片、字体、音频素材
    │   ├── icons/              # 技能和物品图标
    │   └── fonts/
    ├── data/                   # 静态数据资源 (Resources)
    │   ├── items/              # 具体物品资源实例 (.tres)
    │   ├── skills/             # 具体技能资源实例 (.tres)
    │   └── general/            # 泛用游戏配置 (GameConfig.tres)
    ├── scenes/                 # 游戏场景 (.tscn)
    │   ├── main.tscn           # 游戏主入口
    │   ├── ui/                 # UI 组件场景
    │   │   ├── order_card.tscn     # 订单卡片
    │   │   ├── pool_card.tscn      # 奖池卡片
    │   │   ├── inventory_slot.tscn # 背包格子
    │   │   ├── skill_icon.tscn     # 底部技能图标
    │   │   └── modals/             # 弹窗 (技能选择、结算)
    │   └── managers/           # 纯逻辑节点场景 (非 UI)
    ├── scripts/                # GDScript 脚本 (.gd)
    │   ├── globals/            # Autoload 单例脚本
    │   │   ├── game_manager.gd # 核心数值 (Gold, Tickets, InventoryData)
    │   │   ├── event_bus.gd    # 信号总线 (技能触发核心)
    │   │   └── constants.gd    # 常量与枚举 (Rarity, Affix Types)
    │   ├── resources/          # 自定义资源定义 (class_name)
    │   │   ├── item_data.gd    # class_name ItemData
    │   │   ├── skill_data.gd   # class_name SkillData
    │   │   └── pool_config.gd  # class_name PoolConfig
    │   ├── systems/            # 游戏子系统逻辑
    │   │   ├── inventory_sys.gd
    │   │   ├── order_sys.gd
    │   │   ├── pool_sys.gd
    │   │   └── skill_sys.gd    # 专门处理技能逻辑判断
    │   └── ui/                 # UI 控制脚本 (对应 scenes/ui)
    └── project.godot

4. 关键脚本设计规范
    A. 全局单例 (Autoloads)
        1. EventBus (scripts/globals/event_bus.gd)
            作为被动技能系统的核心，所有主要游戏行为必须发出信号，供 SkillSystem 监听修改数据或触发特效。
            signal order_completed(order_data: Dictionary)
            signal item_obtained(item: ItemData)
            signal inventory_updated(items: Array)
            signal draw_requested(pool_type: String, cost: int) - 技能可能会修改 cost
            signal turn_started() / signal turn_ended()

        2. GameManager (scripts/globals/game_manager.gd)
            管理 gold, tickets, mainline_progress。
            管理 current_skills (Array[SkillData])。
            不要在 Setter 中直接写 UI 更新逻辑，而是发出信号。

    B. 资源定义 (Resources)
        1. SkillData (scripts/resources/skill_data.gd)

            class_name SkillData extends Resource

            @export var id: String
            @export var name: String
            @export_multiline var description: String
            @export var icon: Texture2D
            @export var type: String # 'gold', 'luck', 'recycle' 等
            # 可以考虑添加虚函数或枚举来定义技能逻辑类型

    C. UI 与逻辑分离
        UI 节点 (OrderCard.gd) 只负责显示数据和转发输入事件。
        System 节点 (InventorySystem.gd) 负责处理数据逻辑（如合成判断、扣除金币）。
        UI 通过 GameManager 或 EventBus 调用 System 的方法。

    D. 让技能,奖池词缀,主线流程模块化, 能在不修改游戏逻辑的情况下方便地扩展,修改内容
        