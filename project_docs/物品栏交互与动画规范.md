# 物品栏交互与动画规范 (Item Slot Interaction & Animation Spec)

## 1. 核心视觉原则

*   **平滑过渡**：所有颜色的变化都必须是渐变的（Tween），严禁瞬间跳变。
*   **统一反馈**：无论处于何种操作模式（Normal/Recycle/Submit），选中状态的视觉语言必须保持一致。
*   **物理隐喻**：物品的消失、合成、替换需遵循“先关后开”或“先飞后变”的物理逻辑。

## 2. 状态定义与反馈

### 2.1 统一选中状态 (Selected State)
适用于：`Recycle 多选`、`Submit 多选`、`Normal 待换位/待合成`。

*   **视觉表现**：
    *   **悬浮动画 (Hovering)**：`Item_icon` 在 Y 轴上进行正弦波循环浮动（e.g., `±10px`, duration `1.0s`）。
    *   **角标 (Badge)**：根据模式显示不同角标（Recycle 显示叉号，Submit 显示勾号）。
*   **逻辑**：
    *   当 `set_selected(true)` 时，启动 Tween 循环动画。
    *   当 `set_selected(false)` 时，停止 Tween 并 Tween 回原位 `(0, 0)`。

### 2.2 背景色机制 (Background Color)
*   **规则**：永远使用 Tween 渐变。
*   **触发**：`update_display()` 或状态改变时。
*   **参数**：
    *   `from`: 当前颜色 (`modulate` 或 `self_modulate`)
    *   `to`: 目标颜色 (基于 Rarity)
    *   `duration`: `0.5s`
    *   `ease`: `EASE_OUT`

## 3. 交互流程动画详解

### 3.1 合成 / 换位 (Merge / Swap)
*   **场景**：物品 A 从 Slot 1 飞向 Slot 2。
*   **流程**：
    1.  **Fly**: 生成 VFX 代理，从 Slot 1 飞向 Slot 2。
    2.  **Impact**: VFX 到达 Slot 2。
    3.  **Color Morph**: Slot 2 的背景色开始从“旧品质色”渐变到“新品质色”（如果是合成，则是下一阶颜色；如果是换位，则是新物品颜色）。
    4.  **Icon Reveal**: Slot 2 的图标显示（如果是合成，可能会有一个缩放弹出的强调动画）。

### 3.2 回收 (Recycle)
*   **场景**：玩家确认回收，或物品被覆盖/替换时触发。
*   **流程**：
    1.  **Close**: `Item Slot_lid` 播放 `lid_close` 动画（关盖）。
    2.  **Process**:
        *   等待关盖完成。
        *   **Shake**: 播放 `shake` 动画（模拟机器内部处理/粉碎）。
        *   **Data Update**: 在关盖状态下，更新 Slot 数据（清空 Icon，重置背景色为默认）。
    3.  **Open**: `Item Slot_lid` 播放 `lid_open` 动画（开盖）。
    4.  **Result**: 此时玩家看到的是空的格子（或新物品），背景色已平滑过渡完毕。

### 3.3 被替换 (Replaced / Trade-in)
*   **场景**：新物品（如抽奖获得）试图放入一个已有物品的格子，且无法合成（触发替换）。
*   **流程**：
    1.  **Recycle Old**: 目标格子先执行完整的 **3.2 回收流程**（关盖 -> 震动 -> 开盖）。
    2.  **Fly In**: 此时格子已空，新物品从源头（如奖池或鼠标位置）飞入该格子（VFX）。
    3.  **Land & Update**: 物品落地，图标显示，背景色从“空色”渐变到“新物品品质色”。

---

## 4. 伪代码实现思路 (For `item_slot_ui.gd`)

```gdscript
# 伪代码 - 仅作逻辑参考

func update_background_color(target_color: Color) -> void:
    # 强制 Tween 渐变
    if _bg_tween: _bg_tween.kill()
    _bg_tween = create_tween()
    _bg_tween.tween_property(backgrounds, "color", target_color, 0.5)

func set_selected(is_selected: bool) -> void:
    if is_selected:
        # 启动悬浮动画
        if not _hover_tween:
            _hover_tween = create_tween().set_loops()
            _hover_tween.tween_property(icon_display, "position:y", -10, 0.5).as_relative()
            _hover_tween.tween_property(icon_display, "position:y", 10, 0.5).as_relative()
    else:
        # 停止并复位
        if _hover_tween: _hover_tween.kill()
        create_tween().tween_property(icon_display, "position", Vector2.ZERO, 0.2)

func play_recycle_anim() -> Signal:
    # 1. Close
    anim_player.play("lid_close")
    await anim_player.animation_finished
    
    # 2. Shake (可以通过 AnimationPlayer 或代码 Tween)
    await _play_shake()
    
    # 3. Data Update (External Logic should call update_display here or before open)
    
    # 4. Open
    anim_player.play("lid_open")
    await anim_player.animation_finished
    return anim_player.animation_finished
```

