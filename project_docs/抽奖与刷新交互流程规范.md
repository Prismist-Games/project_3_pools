# 抽奖与刷新交互流程规范 (Lottery & Refresh Interaction Flow Spec)

## 1. 核心流程概述

本项目采用**“Push-Away（推挤刷新）”**机制，利用 Pseudo (伪) 节点实现新旧内容的无缝视觉交替。当奖池刷新时，旧内容被“推”出视野，新内容同时被“推”入视野，创造出机械滚轮或滑动的物理质感。

## 2. 交互阶段详解

### 阶段一：悬停预热 (Hover Phase)
*   **状态**：玩家鼠标悬停在 Lottery Slot 上。
*   **视觉**：`Lottery Slot_lid`（真盖子）轻微向上浮动（通过 Tween 或 AnimationPlayer 的 `hover` 动画）。
*   **逻辑**：检查是否满足抽奖条件（金币/道具），改变鼠标指针样式。

### 阶段二：揭示时刻 (Reveal Phase)
*   **触发**：玩家点击 Slot。
*   **视觉**：
    1.  **开盖**：播放 `lid_open` 动画。
    2.  **洗牌**：`Lottery Slot_backgrounds` 的颜色快速变化并定格在对应奖池类型的颜色。
    3.  **弹射**：`Item_main` 显示物品图标，并播放弹出/放大动画。

### 阶段三：待定与入包 (Pending Phase)
*   **状态**：物品展示在 `Item_main`，等待进入背包。
*   **分支 A：成功入包**
    *   `Item_main` 隐藏。
    *   生成 VFX 飞行特效飞向背包目标格子。
    *   进入 **阶段四：推挤刷新**。
*   **分支 B：背包已满/放弃**
    *   `Lottery Slot_lid` 播放 `lid_close` 动画（无 Push 效果）。
    *   播放 Shake 动画提示错误或放弃。
    *   进入 **阶段四：推挤刷新** (如果选择了放弃并刷新)。

### 阶段四：推挤刷新 (Push-Away Phase)
*   **前置条件**：物品已处理完毕。
*   **动作逻辑**：
    1.  如果盖子是开启状态，先播放 `lid_close`。
    2.  **锁定 UI**：禁止再次点击。
    3.  **数据预加载**：将下一次抽奖的数据（价格、新奖池名、新词缀等）赋值给 **Pseudo 节点**。
    4.  **播放推挤动画**：所有 True 节点移出，Pseudo 节点移入。
    5.  **重置 (Reset)**：
        *   动画结束瞬间，将 Pseudo 节点的数据同步给 True 节点。
        *   瞬间重置 True 节点和 Pseudo 节点的位置（True 回到视野中心，Pseudo 回到初始隐藏位置）。
    6.  **解锁 UI**。

---

## 3. 节点结构映射 (Node Mapping)

基于 `scenes/ui_module/lottery_slot_root_0.tscn` 的实际结构。

### 3.1 垂直推挤组 (Vertical Push Group)
*方向：旧内容向下移出，新内容从上方移入。*

| 组件 | 父容器 (Mask) | True Node (当前显示) | Pseudo Node (下一轮预告) | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **盖子** | `Lottery Slot_mask` | `Lottery Slot_lid` | `Lottery Slot_lid/Lottery Slot_lid_psudo` | 包含 Icon, Label, Outline |
| **词缀** | `Lottery Slot_top_screen_fill` | `Affix Label` | `Affix Label/Affix Label_psudo` | RichTextLabel |
| **价格** | `Lottery Slot_top_screen_fill` | `Price Label` | `Price Label/Price Label_psudo` | RichTextLabel |

*(注意：`Price Icon` 目前在场景中似乎是静态的，若需动画需确认是否跟随 Price Label 移动)*

### 3.2 水平推挤组 (Horizontal Push Group)
*方向：旧内容向右移出，新内容从左侧移入。*

| 组件 | 父容器 (Mask) | True Node (当前显示) | Pseudo Node (下一轮预告) | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **需求图标** | `Lottery Slot_right_screen_fill` | `Lottery Required Items Icon Grid` | `Lottery Required Items Icon Grid_psudo` | VBoxContainer |
| **描述文本** | `Lottery Slot_description_screen_fill` | `Description Label` | `Description Label/Description Label_psudo` | RichTextLabel |

---

## 4. 关键脚本逻辑 (`lottery_slot_ui.gd`)

### 4.1 变量定义
需要获取对所有 True 和 Pseudo 节点的引用。

```gdscript
# True Nodes
@onready var lid_root: Sprite2D = $"Lottery Slot_mask/Lottery Slot_lid"
@onready var affix_label: RichTextLabel = $"Lottery Slot_top_screen/Lottery Slot_top_screen_fill/Affix Label"
@onready var price_label: RichTextLabel = $"Lottery Slot_top_screen/Lottery Slot_top_screen_fill/Price Label"
@onready var req_grid: VBoxContainer = $"Lottery Slot_right_screen/Lottery Slot_right_screen_fill/Lottery Required Items Icon Grid"
@onready var desc_label: RichTextLabel = $"Lottery Slot_description_screen/Lottery Slot_description_screen_fill/Description Label"

# Pseudo Nodes
@onready var lid_pseudo: Sprite2D = $"Lottery Slot_mask/Lottery Slot_lid/Lottery Slot_lid_psudo"
@onready var affix_label_pseudo: RichTextLabel = $"Lottery Slot_top_screen/Lottery Slot_top_screen_fill/Affix Label/Affix Label_psudo"
@onready var price_label_pseudo: RichTextLabel = $"Lottery Slot_top_screen/Lottery Slot_top_screen_fill/Price Label/Price Label_psudo"
@onready var req_grid_pseudo: VBoxContainer = $"Lottery Slot_right_screen/Lottery Slot_right_screen_fill/Lottery Required Items Icon Grid_psudo"
@onready var desc_label_pseudo: RichTextLabel = $"Lottery Slot_description_screen/Lottery Slot_description_screen_fill/Description Label/Description Label_psudo"
```

### 4.2 刷新函数 (`refresh_slot_data`)

```gdscript
func refresh_slot_data(new_pool_data: PoolConfig, is_instant: bool = false) -> void:
    if is_instant:
        # 游戏初始化时直接设置 True Nodes
        _update_visuals(new_pool_data, false) # false = targeting true nodes
    else:
        # 运行时刷新：设置 Pseudo Nodes 并播放动画
        _update_visuals(new_pool_data, true)  # true = targeting pseudo nodes
        await _play_push_away_animation()
        
        # 动画结束后，将数据同步到 True Nodes 并复位
        _update_visuals(new_pool_data, false)
        _reset_positions()
```

### 4.3 动画细节
使用 `Tween` 并行处理移动。

*   **Vertical Push**:
    *   `lid_root.position.y` 从 `0` -> `OFFSET`
    *   `lid_pseudo.position.y` 从 `-OFFSET` -> `0`
    *   (Labels 同理)
*   **Horizontal Push**:
    *   `req_grid.position.x` 从 `X` -> `X + WIDTH`
    *   `req_grid_pseudo.position.x` 从 `X - WIDTH` -> `X`
    *   (Description 同理)

---

## 5. 开发注意事项

1.  **拼写检查**：场景中的节点命名使用了 `psudo` (缺少 e)，代码中需严格匹配该拼写，或在编辑器中批量修正为 `pseudo`（建议修正以保持专业性，但若不想动场景则需迁就）。
2.  **裁剪 (Clipping)**：确保所有 Mask 父节点（`_fill` 结尾的节点）的 `Clip Children` 属性已设置为 `Clip Only` 或 `Clip + Draw`，否则推挤动画会溢出显示范围。
3.  **Z-Index**：确保盖子 (`Lid`) 的 Z-Index 高于物品 (`Item_main`)，以便关盖时遮挡物品。

