# **奖池词缀 (Pool Affix) 系统设计规范**

这份文档详细定义了“抽抽乐”游戏中奖池词缀的功能逻辑，用于指导 Godot 项目中 PoolSystem 及相关交互逻辑的开发。

## **1\. 核心概念**

词缀 (Affix) 是附加在 奖池 (Pool) 上的特殊属性，它会改变玩家点击奖池时的行为。词缀主要分为两类：

1. **被动型 (Passive)**: 点击即触发抽奖，但改变掉落规则（如概率、数量、物品状态）。
2. **交互型 (Interaction)**: 点击后不立即抽奖，而是进入特殊交互模式（如选择物品、消耗物品）。

## **2\. 数据结构建议 (Resource)**

在 Godot 中，建议使用 AffixData (Resource) 来存储词缀定义：

class\_name AffixData extends Resource

@export var id: String          \# 例如 "hardened", "trade\_in"
@export var name: String        \# 显示名称
@export var description: String \# 描述文本
@export var cost\_override: int \= 0 \# 基础消耗覆盖（如果 \>0）
@export var type: String        \# "passive" 或 "interaction"

## **3\. 词缀效果详解**

### **A. 被动型词缀 (Passive)**

这类词缀在 PoolSystem.draw() 过程中直接生效。


| ID             | 名称       | 消耗 (Cost) | 逻辑描述                                                                                                               | 实现建议 (PoolSystem)                                               |
| :--------------- | :----------- | :------------ | :----------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------- |
| **hardened**   | **硬化的** | 2 金币      | 1\. **概率提升**: 只有稀有(Rare)及以上品质。 2\. **副作用**: 获得的物品带有 sterile: true 标记（绝育），无法参与合成。 | 修改 RollRarity 权重表。 生成 ItemData 后设置 is\_sterile \= true。 |
| **purified**   | **提纯的** | 3 金币      | 1\. **保底机制**: 必定获得稀有(Rare)或更高品质。 *(参考概率: Rare 67%, Epic 30%, Legendary 3%)*                        | 修改 RollRarity 函数，移除 Common/Uncommon 的权重。                 |
| **volatile**   | **波动的** | 1 金币      | 1\. **极端概率**: 只能获得 普通(Common) 或 传说(Legendary)。 *(参考概率: Common 92%, Legendary 8%)*                    | 修改 RollRarity 函数，仅保留这两种品质的权重。                      |
| **fragmented** | **稀碎的** | 1 金币      | 1\. **数量加成**: 一次抽奖获得 **3 个** 物品。 2\. **品质锁定**: 所有物品必定为 **普通(Common)**。                     | 循环执行 3 次物品生成逻辑。 强制设置 rarity\= common。              |

### **B. 交互型词缀 (Interaction)**

这类词缀点击奖池时，**不扣费、不立即生成物品**，而是发出信号让 UI 进入特定模式。


| ID            | 名称           | 消耗 (Cost) | 交互流程                                                                                                                                                                                                      | 实现建议 (EventBus/UI)                                                                                                                       |
| :-------------- | :--------------- | :------------ | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------- |
| **trade\_in** | **以旧换新的** | 1 金币      | 1\. 玩家点击奖池 \-\> 进入 **"选择消耗品"** 模式。 2\. 玩家点击背包中任意一个 **非主线** 物品。 3\. **执行置换**: 移除该物品，从奖池中随机抽取一个 **同品质** 的新物品放入背包。 4\. *小概率 (5%) 升级品质*。 | 1\. 发出 enter\_selection\_mode("trade\_in")。 2\. 背包监听点击事件，若选中有效物品，调用 PoolSystem.execute\_trade\_in(item, pool)。        |
| **precise**   | **精准的**     | 2 金币      | 1\. 玩家点击奖池 \-\> 扣除金币。 2\. 系统随机生成 **2 个** 不同的候选物品。 3\. 弹出 **"二选一"** 窗口。 4\. 玩家选择其中一个获得，另一个丢弃。                                                               | 1\. 扣费。 2\. 生成 2 个临时 ItemData。 3\. 发出 show\_selection\_modal(items) 信号。 4\. 弹窗返回结果后，调用 InventorySystem.add\_item()。 |
| **targeted**  | **有的放矢的** | 4 金币      | 1\. 玩家点击奖池 \-\> 扣除金币。 2\. 展示该奖池内所有可能的物品类型（如所有水果）。 3\. 玩家手动点击选择想要的那一种。 4\. 必定获得该物品（品质随机）。                                                       | 1\. 扣费。 2\. 发出 show\_pool\_items\_modal(pool)。 3\. 玩家选择后，生成指定 ItemData 并添加。                                              |

## **4\. 技能与词缀的交互 (Skill Interactions)**

在实现词缀逻辑时，需要预留“钩子”给 SkillSystem 介入：

1. **vip\_discount (贵宾折扣)**:
   * **效果**: precise 和 targeted 的消耗减少 1 金币。
   * **实现**: 在计算 Cost 时，检查当前 Pool 的 affix type 是否为 interaction 以及具体的 ID。
2. **resource\_integration (资源整合 \- 待定)**:
   * **效果**: trade\_in 不消耗金币反而获得金币。
   * **实现**: 在 execute\_trade\_in 逻辑中检查技能。
